<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camden Cats - Team Summaries</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .table-container::-webkit-scrollbar { width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #1f2937; }
        .table-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; border: 2px solid #1f2937; }
        
        /* Tab Styles */
        .tab-button {
            transition: background-color 0.3s, color 0.3s;
            background-color: #374151; /* bg-gray-700 */
            color: #d1d5db; /* text-gray-300 */
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        .tab-button.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: #ffffff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-sm shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="./landing.html" class="flex items-center">
                        <img src="assets/camden_cats_logo.jpg" alt="Camden Cats Logo" class="h-10 w-10 rounded-full object-cover" 
                             onerror="this.onerror=null; this.src='https://placehold.co/40x40/1a202c/ffffff?text=Logo';">
                        <span class="ml-3 font-semibold text-xl">Camden Cats Analytics</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                     <a href="./landing.html" class="text-sm font-medium text-gray-400 hover:text-white transition-colors duration-200">Back to Dashboard</a>
                    <button id="logout-button" class="text-sm font-medium text-gray-400 hover:text-white transition-colors duration-200">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold tracking-tight">Team Performance Analyzer</h1>
            <p class="mt-3 max-w-2xl mx-auto text-lg text-gray-400">Aggregated match data automatically analyzed from the team's GitHub repository.</p>
        </div>

        <main>
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-16 card">
                <div class="flex flex-col items-center justify-center">
                    <div class="loader"></div>
                    <p id="loading-text" class="text-gray-400 mt-4">Fetching & analyzing match data...</p>
                </div>
                <div id="file-list" class="mt-4 text-center text-sm text-gray-500"></div>
            </div>

            <!-- Tabs Navigation -->
            <div id="tabs-container" class="hidden mb-8">
                <div class="grid grid-cols-2 lg:grid-cols-5 bg-gray-800 rounded-lg p-1 gap-1">
                    <button data-tab="scoring-zone" class="tab-button w-full">Scoring Zone</button>
                    <button data-tab="transitions" class="tab-button w-full">D50 to F50</button>
                    <button data-tab="i45-conversion" class="tab-button w-full">I45 Conversion</button>
                    <button data-tab="scoring-efficiency" class="tab-button w-full">Scoring Efficiency</button>
                    <button data-tab="gps-summary" class="tab-button w-full">GPS Summaries</button>
                </div>
            </div>

            <!-- Analysis Results Section -->
            <div id="results-section" class="hidden">
                <!-- Tab 1: Scoring Zone Analysis -->
                <div id="scoring-zone-content" class="tab-content space-y-8">
                    <div class="card"><h2 class="text-2xl font-bold text-white text-center">Overall Scoring Zone Analysis</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6"><div class="card text-center bg-gray-900/50"><h3 class="text-lg font-medium text-gray-400">Scores from Drop Zone</h3><p id="drop-zone-percentage" class="text-4xl font-bold text-green-400 mt-2">0%</p><p id="drop-zone-count" class="text-sm text-gray-500 mt-1">(0 of 0 scores)</p></div><div class="card text-center bg-gray-900/50"><h3 class="text-lg font-medium text-gray-400">Scores from Rebound Zone</h3><p id="rebound-zone-percentage" class="text-4xl font-bold text-blue-400 mt-2">0%</p><p id="rebound-zone-count" class="text-sm text-gray-500 mt-1">(0 of 0 scores)</p></div></div><div id="goal-results-section" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="card !p-4 text-center bg-gray-900/50"><h3 class="text-md font-medium text-gray-400">Goals from Drop Zone</h3><p id="goal-drop-zone-percentage" class="text-3xl font-bold text-green-400 mt-1">0%</p><p id="goal-drop-zone-count" class="text-xs text-gray-500 mt-1">(0 of 0 goals)</p></div><div class="card !p-4 text-center bg-gray-900/50"><h3 class="text-md font-medium text-gray-400">Goals from Rebound Zone</h3><p id="goal-rebound-zone-percentage" class="text-3xl font-bold text-blue-400 mt-1">0%</p><p id="goal-rebound-zone-count" class="text-xs text-gray-500 mt-1">(0 of 0 goals)</p></div></div></div>
                    <div class="card"><h3 class="text-xl font-semibold text-white mb-4">Match-by-Match Breakdown</h3><div class="table-container"><table class="min-w-full"><thead class="bg-gray-700 sticky top-0"><tr><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">File Name</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Total Scores</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Drop Zone % (Scores)</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Total Goals</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Drop Zone % (Goals)</th></tr></thead><tbody id="match-summary-body" class="divide-y divide-gray-700"></tbody></table></div></div>
                </div>

                <!-- Tab 2: D50 to F50 Transitions -->
                <div id="transitions-content" class="tab-content space-y-8">
                    <div class="card text-center"><h2 class="text-2xl font-bold text-white mb-4">Overall D50 to F50 Transition Analysis</h2><h3 class="text-lg font-medium text-gray-400">Transition Success Rate</h3><p id="transition-percentage" class="text-4xl font-bold text-teal-400 mt-2">0%</p><p id="transition-count" class="text-sm text-gray-500 mt-1">(0 successful of 0 attempts)</p></div>
                    <div class="card"><h3 class="text-xl font-semibold text-white mb-4">Match-by-Match Breakdown</h3><div class="table-container"><table class="min-w-full"><thead class="bg-gray-700 sticky top-0"><tr><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">File Name</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Transition Attempts</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Successful Transitions</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Success Rate</th></tr></thead><tbody id="transition-summary-body" class="divide-y divide-gray-700"></tbody></table></div></div>
                </div>

                <!-- Tab 3: Inside 45 Conversion -->
                <div id="i45-conversion-content" class="tab-content space-y-8">
                    <div class="card text-center"><h2 class="text-2xl font-bold text-white mb-4">Overall Inside 45 Conversion Analysis</h2><h3 class="text-lg font-medium text-gray-400">I45 to F50 Conversion Rate</h3><p id="i45-conversion-percentage" class="text-4xl font-bold text-orange-400 mt-2">0%</p><p id="i45-conversion-count" class="text-sm text-gray-500 mt-1">(0 conversions from 0 kicks)</p></div>
                    <div class="card"><h3 class="text-xl font-semibold text-white mb-4">Match-by-Match Breakdown</h3><div class="table-container"><table class="min-w-full"><thead class="bg-gray-700 sticky top-0"><tr><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">File Name</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">I45 Kicks</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Successful Conversions</th><th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Conversion Rate</th></tr></thead><tbody id="i45-summary-body" class="divide-y divide-gray-700"></tbody></table></div></div>
                </div>

                <!-- Tab 4: Scoring Efficiency -->
                <div id="scoring-efficiency-content" class="tab-content space-y-8">
                    <div class="card"><h2 class="text-2xl font-bold text-white mb-6 text-center">Overall Scoring Efficiency</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="card bg-gray-900/50"><h3 class="text-xl font-semibold text-white mb-4 text-center">Camden Cats</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="text-center bg-gray-800 p-4 rounded-lg"><h4 class="text-lg font-medium text-gray-400">I50s per Score</h4><p id="team-i50-per-score" class="text-3xl font-bold text-indigo-400 mt-1">0.0</p></div><div class="text-center bg-gray-800 p-4 rounded-lg"><h4 class="text-lg font-medium text-gray-400">I50s per Goal</h4><p id="team-i50-per-goal" class="text-3xl font-bold text-indigo-400 mt-1">0.0</p></div></div></div><div class="card bg-gray-900/50"><h3 class="text-xl font-semibold text-white mb-4 text-center">Opposition</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="text-center bg-gray-800 p-4 rounded-lg"><h4 class="text-lg font-medium text-gray-400">I50s per Score</h4><p id="oppo-i50-per-score" class="text-3xl font-bold text-rose-400 mt-1">0.0</p></div><div class="text-center bg-gray-800 p-4 rounded-lg"><h4 class="text-lg font-medium text-gray-400">I50s per Goal</h4><p id="oppo-i50-per-goal" class="text-3xl font-bold text-rose-400 mt-1">0.0</p></div></div></div></div></div>
                    <div class="card"><h3 class="text-xl font-semibold text-white mb-4">Match-by-Match Efficiency</h3><div class="table-container"><table class="min-w-full"><thead class="bg-gray-700 sticky top-0"><tr><th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">File Name</th><th scope="col" class="px-2 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Cats I50s/Score</th><th scope="col" class="px-2 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Cats I50s/Goal</th><th scope="col" class="px-2 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Oppo I50s/Score</th><th scope="col" class="px-2 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Oppo I50s/Goal</th></tr></thead><tbody id="efficiency-summary-body" class="divide-y divide-gray-700"></tbody></table></div></div>
                </div>
                
                <!-- Tab 5: GPS Game Summaries -->
                <div id="gps-summary-content" class="tab-content space-y-8">
                    <div class="card"><h2 class="text-2xl font-bold text-white mb-6 text-center">GPS Win/Loss Averages</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="card border-2 border-green-500/50 bg-gray-900/50"><h3 class="text-xl font-semibold text-green-400 mb-4 text-center">Winning Games (<span id="win-count">0</span>)</h3><div id="gps-win-summary" class="space-y-3"></div></div><div class="card border-2 border-red-500/50 bg-gray-900/50"><h3 class="text-xl font-semibold text-red-400 mb-4 text-center">Losing Games (<span id="loss-count">0</span>)</h3><div id="gps-loss-summary" class="space-y-3"></div></div></div></div>
                    <div class="card"><h3 class="text-xl font-semibold text-white mb-4">Team Averages Per Match</h3><div class="table-container"><table class="min-w-full"><thead class="bg-gray-700 sticky top-0"><tr><th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">File Name</th><th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Result</th><th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Total Dist. (m)</th><th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Sprint Dist. (m)</th><th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Sprint Efforts</th><th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Hard Running (m)</th><th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Hard Running Efforts</th><th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Work Rate (m/min)</th></tr></thead><tbody id="gps-summary-body" class="divide-y divide-gray-700"></tbody></table></div></div>
                </div>
            </div>
            
            <div id="no-results" class="text-center py-8 text-gray-500 hidden"><p>No relevant data found in the provided files to generate analysis.</p></div>
            <div id="error-message" class="hidden mt-6 text-center text-red-400 bg-red-900/50 p-4 rounded-lg whitespace-pre-wrap"></div>
        </main>
    </main>

    <script>
        // --- AUTHENTICATION CHECK ---
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = './index.html';
        }
        document.getElementById('logout-button').addEventListener('click', function() {
            sessionStorage.removeItem('isLoggedIn');
            window.location.href = './index.html';
        });

        document.addEventListener('DOMContentLoaded', () => {
            // --- GitHub Configuration ---
            const GITHUB_USER = "NickPez36";
            const GITHUB_REPO = "Camden_Match_Analytics";
            const XML_DATA_PATH = "data/Team_Review__Team_XML";
            const GPS_DATA_PATH = "data/Team_Review_GPS_csv";

            // --- DOM element references ---
            const loadingState = document.getElementById('loading-state');
            const loadingText = document.getElementById('loading-text');
            const fileListDisplay = document.getElementById('file-list');
            const tabsContainer = document.getElementById('tabs-container');
            const resultsSection = document.getElementById('results-section');
            const noResultsMessage = document.getElementById('no-results');
            const errorMessage = document.getElementById('error-message');

            // Tab 1: Scoring Zone
            const dropZonePercentage = document.getElementById('drop-zone-percentage'), dropZoneCount = document.getElementById('drop-zone-count'), reboundZonePercentage = document.getElementById('rebound-zone-percentage'), reboundZoneCount = document.getElementById('rebound-zone-count'), goalResultsSection = document.getElementById('goal-results-section'), goalDropZonePercentage = document.getElementById('goal-drop-zone-percentage'), goalDropZoneCount = document.getElementById('goal-drop-zone-count'), goalReboundZonePercentage = document.getElementById('goal-rebound-zone-percentage'), goalReboundZoneCount = document.getElementById('goal-rebound-zone-count'), matchSummaryBody = document.getElementById('match-summary-body');
            // Tab 2: Transitions
            const transitionPercentage = document.getElementById('transition-percentage'), transitionCount = document.getElementById('transition-count'), transitionSummaryBody = document.getElementById('transition-summary-body');
            // Tab 3: I45 Conversion
            const i45ConversionPercentage = document.getElementById('i45-conversion-percentage'), i45ConversionCount = document.getElementById('i45-conversion-count'), i45SummaryBody = document.getElementById('i45-summary-body');
            // Tab 4: Scoring Efficiency
            const teamI50PerScore = document.getElementById('team-i50-per-score'), teamI50PerGoal = document.getElementById('team-i50-per-goal'), oppoI50PerScore = document.getElementById('oppo-i50-per-score'), oppoI50PerGoal = document.getElementById('oppo-i50-per-goal'), efficiencySummaryBody = document.getElementById('efficiency-summary-body');
            // Tab 5: GPS Summary
            const gpsSummaryBody = document.getElementById('gps-summary-body');
            const gpsWinSummary = document.getElementById('gps-win-summary');
            const gpsLossSummary = document.getElementById('gps-loss-summary');
            const winCountSpan = document.getElementById('win-count');
            const lossCountSpan = document.getElementById('loss-count');

            // --- Event Listeners ---
            tabsContainer.addEventListener('click', (e) => { if (e.target.matches('.tab-button')) switchTab(e.target.dataset.tab); });

            function switchTab(tabId) {
                document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(`${tabId}-content`).classList.add('active');
            }

            async function fetchDataFromGitHub() {
                loadingState.classList.remove('hidden');
                fileListDisplay.textContent = '';
                hideError();
                resultsSection.classList.add('hidden');
                
                try {
                    loadingText.textContent = 'Fetching XML file list...';
                    const xmlFiles = await fetchRepoFiles(XML_DATA_PATH, '.xml');
                    
                    loadingText.textContent = 'Fetching GPS file list...';
                    const gpsFiles = await fetchRepoFiles(GPS_DATA_PATH, '.csv');

                    if (xmlFiles.length === 0 && gpsFiles.length === 0) {
                        showError('No XML or CSV files found in the specified GitHub directories.');
                        return;
                    }

                    loadingText.textContent = `Found ${xmlFiles.length} XML and ${gpsFiles.length} CSV file(s). Fetching content...`;

                    const xmlPromises = xmlFiles.map(file => fetchAndReadFile(file));
                    const gpsPromises = gpsFiles.map(file => fetchAndReadFile(file));

                    const allXmlContents = await Promise.all(xmlPromises);
                    const allGpsContents = await Promise.all(gpsPromises);
                    
                    processAllFiles(allXmlContents, allGpsContents);

                } catch (error) {
                    showError(`Failed to fetch data: ${error.message}`);
                } finally {
                    loadingState.classList.add('hidden');
                }
            }
            
            async function fetchRepoFiles(path, extension) {
                const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`GitHub API error for path ${path}: ${response.statusText}`);
                const files = await response.json();
                return files.filter(file => file.name.endsWith(extension));
            }

            function fetchAndReadFile(file) {
                const cacheBuster = `?t=${new Date().getTime()}`;
                return fetch(file.download_url + cacheBuster)
                    .then(res => {
                        if (!res.ok) throw new Error(`Failed to download ${file.name}`);
                        return res.blob();
                    })
                    .then(blob => new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve({ name: file.name, content: reader.result });
                        reader.onerror = () => reject(new Error(`Failed to read file ${file.name}`));
                        reader.readAsText(blob); 
                    }));
            }

            function processAllFiles(allXmlContents, allGpsContents) {
                let failedFiles = [];
                
                const allMatchStats = allXmlContents.map(file => {
                    try { 
                        return parseAndAnalyzeSingleFile(file.content, file.name);
                    }
                    catch (e) { 
                        failedFiles.push({ name: file.name, message: e.message });
                        return null; 
                    }
                }).filter(Boolean);

                const allGpsStats = allGpsContents.map(file => {
                    try {
                        return parseAndAnalyzeGpsFile(file.content, file.name);
                    } catch (e) {
                        failedFiles.push({ name: file.name, message: e.message });
                        return null;
                    }
                }).filter(Boolean);
                
                if (failedFiles.length > 0) {
                    const errorText = failedFiles.map(f => `• ${f.name}: ${f.message}`).join('\n');
                    showError(`Could not process ${failedFiles.length} file(s):\n${errorText}`);
                }

                const filesProcessed = allMatchStats.length + allGpsStats.length;
                const totalFiles = allXmlContents.length + allGpsContents.length;

                if (filesProcessed > 0 && failedFiles.length === 0) {
                     fileListDisplay.textContent = `Successfully analyzed all ${filesProcessed} file(s).`;
                } else if (filesProcessed > 0 && failedFiles.length > 0) {
                     fileListDisplay.textContent = `Successfully analyzed ${filesProcessed} of ${totalFiles} file(s).`;
                } else {
                     fileListDisplay.textContent = '';
                }

                if (allMatchStats.length > 0 || allGpsStats.length > 0) { 
                    updateAggregatedUI(allMatchStats, allGpsStats); 
                } else { 
                    resultsSection.classList.add('hidden'); 
                    tabsContainer.classList.add('hidden');
                    if (errorMessage.textContent.length === 0) {
                        noResultsMessage.classList.remove('hidden');
                    }
                }
            }

            function parseAndAnalyzeSingleFile(xmlString, fileName) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "text/xml");
                
                const parserError = xmlDoc.querySelector("parsererror");
                if (parserError) {
                    console.error(`Parser Error in file: ${fileName}`, parserError.textContent);
                    throw new Error(`Malformed XML: ${parserError.textContent.split('\n')[0]}`);
                }

                const allEvents = Array.from(xmlDoc.getElementsByTagName('instance')).map((inst) => ({
                    code: inst.querySelector('code')?.textContent.trim() || '',
                    start: parseFloat(inst.querySelector('start')?.textContent || 0),
                    end: parseFloat(inst.querySelector('end')?.textContent || 0),
                })).sort((a, b) => a.start - b.start);

                const teamGoalEvents = ["Goal - Field Play", "Goal - Set Shot"], teamBehindEvents = ["Behind - Field Play", "Behind - Set Shot"], teamScoringEvents = [...teamGoalEvents, ...teamBehindEvents], oppoGoalEvents = ["Oppo Goal - Field Play", "Oppo Goal - Set Shot"], oppoBehindEvents = ["Oppo Behind - Field Play", "Oppo Behind - Set Shot"], oppoScoringEvents = [...oppoGoalEvents, ...oppoBehindEvents], oppoI50Events = ["Oppo Forward 50 Entry (Fast)", "Oppo Forward 50 Entry (Slow)"];
                
                let teamI50s = 0, teamScores = 0, teamGoals = 0, oppoI50s = 0, oppoScores = 0, oppoGoals = 0, dropZoneScores = 0, reboundZoneScores = 0, dropZoneGoals = 0, reboundZoneGoals = 0, transitionAttempts = 0, successfulTransitions = 0, i45Kicks = 0, successfulI45Conversions = 0;

                allEvents.forEach((event, i) => {
                    if (event.code === "Inside 50") teamI50s++;
                    if (teamScoringEvents.includes(event.code)) teamScores++;
                    if (teamGoalEvents.includes(event.code)) teamGoals++;
                    if (oppoI50Events.includes(event.code)) oppoI50s++;
                    if (oppoScoringEvents.includes(event.code)) oppoScores++;
                    if (oppoGoalEvents.includes(event.code)) oppoGoals++;
                    if (teamScoringEvents.includes(event.code)) {
                        for (let j = i - 1; j >= 0; j--) {
                            if (allEvents[j].code.startsWith("Inside 50 (")) {
                                const isDropZone = allEvents[j].code === "Inside 50 (Drop Zone)";
                                if (isDropZone) dropZoneScores++; else reboundZoneScores++;
                                if (teamGoalEvents.includes(event.code)) { if (isDropZone) dropZoneGoals++; else reboundZoneGoals++; }
                                break;
                            }
                        }
                    }
                    const transitionStartEvents = ["Kick out - Fast", "Kick out - Slow", "Fast Rebound 50", "Slow Defensive Exit"];
                    if (transitionStartEvents.includes(event.code)) {
                        transitionAttempts++;
                        for (let j = i + 1; j < allEvents.length; j++) {
                            const subsequentEvent = allEvents[j];
                            if (subsequentEvent.code.includes("Stoppage") || subsequentEvent.code.includes("Direct Turnover")) break;
                            if (subsequentEvent.code === "Inside 50") { successfulTransitions++; break; }
                        }
                    }
                    if (event.code === "Inside 45 kick") {
                        i45Kicks++;
                        for (let j = i + 1; j < allEvents.length; j++) {
                            const subsequentEvent = allEvents[j];
                            if (subsequentEvent.start > event.end + 10) break;
                            if (subsequentEvent.code === "Inside 50" && subsequentEvent.start <= event.end + 10) { successfulI45Conversions++; break; }
                        }
                    }
                });

                return { fileName, teamI50s, teamScores, teamGoals, oppoI50s, oppoScores, oppoGoals, dropZoneScores, reboundZoneScores, dropZoneGoals, reboundZoneGoals, transitionAttempts, successfulTransitions, i45Kicks, successfulI45Conversions };
            }

            function parseAndAnalyzeGpsFile(csvString, fileName) {
                if (csvString.charCodeAt(0) === 0xFEFF) { csvString = csvString.substring(1); }
                const rows = csvString.split('\n').map(row => row.trim().split(','));
                const headers = rows[0].map(h => h.trim());
                const data = rows.slice(1).map(row => {
                    const rowData = {};
                    headers.forEach((header, i) => { rowData[header] = row[i] ? row[i].trim() : ''; });
                    return rowData;
                });

                const playerStats = {};
                const requiredColumns = ['Player Name', 'Segment Name', 'Total Distance [m]', 'Sprint Distance [m]', 'Sprint Efforts', 'Hard Running [m]', 'Hard Running Efforts', 'Work Rate [m/min]', 'Event Result'];
                
                for (const col of requiredColumns) {
                    if (!headers.includes(col)) throw new Error(`Missing required column in CSV: "${col}"`);
                }

                let gameResult = data.length > 0 ? data[0]['Event Result'] : 'Unknown';

                data.forEach(row => {
                    if (row['Segment Name'] && row['Segment Name'] !== 'Game Total' && row['Player Name']) {
                        const playerName = row['Player Name'];
                        if (!playerStats[playerName]) { playerStats[playerName] = { totalDistance: 0, sprintDistance: 0, sprintEfforts: 0, hardRunning: 0, hardRunningEfforts: 0, workRateSum: 0, workRateCount: 0 }; }
                        playerStats[playerName].totalDistance += parseFloat(row['Total Distance [m]']) || 0;
                        playerStats[playerName].sprintDistance += parseFloat(row['Sprint Distance [m]']) || 0;
                        playerStats[playerName].sprintEfforts += parseInt(row['Sprint Efforts']) || 0;
                        playerStats[playerName].hardRunning += parseFloat(row['Hard Running [m]']) || 0;
                        playerStats[playerName].hardRunningEfforts += parseInt(row['Hard Running Efforts']) || 0;
                        const workRate = parseFloat(row['Work Rate [m/min]']);
                        if (!isNaN(workRate)) { playerStats[playerName].workRateSum += workRate; playerStats[playerName].workRateCount++; }
                    }
                });

                const numPlayers = Object.keys(playerStats).length;
                if (numPlayers === 0) return null;

                const teamTotals = { totalDistance: 0, sprintDistance: 0, sprintEfforts: 0, hardRunning: 0, hardRunningEfforts: 0, workRate: 0 };

                for (const player in playerStats) {
                    teamTotals.totalDistance += playerStats[player].totalDistance;
                    teamTotals.sprintDistance += playerStats[player].sprintDistance;
                    teamTotals.sprintEfforts += playerStats[player].sprintEfforts;
                    teamTotals.hardRunning += playerStats[player].hardRunning;
                    teamTotals.hardRunningEfforts += playerStats[player].hardRunningEfforts;
                    if (playerStats[player].workRateCount > 0) { teamTotals.workRate += (playerStats[player].workRateSum / playerStats[player].workRateCount); }
                }
                
                return { fileName, gameResult, avgTotalDistance: teamTotals.totalDistance / numPlayers, avgSprintDistance: teamTotals.sprintDistance / numPlayers, avgSprintEfforts: teamTotals.sprintEfforts / numPlayers, avgHardRunning: teamTotals.hardRunning / numPlayers, avgHardRunningEfforts: teamTotals.hardRunningEfforts / numPlayers, avgWorkRate: teamTotals.workRate / numPlayers };
            }


            function updateAggregatedUI(allMatchStats, allGpsStats) {
                const overall = allMatchStats.reduce((acc, match) => { for (const key in match) { if (key !== 'fileName') acc[key] = (acc[key] || 0) + match[key]; } return acc; }, {});

                // --- Update XML-based Tabs ---
                if (allMatchStats.length > 0) {
                    // Scoring Zone
                    dropZonePercentage.textContent = `${overall.teamScores > 0 ? ((overall.dropZoneScores / overall.teamScores) * 100).toFixed(1) : '0.0'}%`;
                    dropZoneCount.textContent = `(${overall.dropZoneScores} of ${overall.teamScores} scores)`;
                    reboundZonePercentage.textContent = `${overall.teamScores > 0 ? (((overall.teamScores - overall.dropZoneScores) / overall.teamScores) * 100).toFixed(1) : '0.0'}%`;
                    reboundZoneCount.textContent = `(${overall.teamScores - overall.dropZoneScores} of ${overall.teamScores} scores)`;
                    if (overall.teamGoals > 0) {
                        goalResultsSection.classList.remove('hidden');
                        goalDropZonePercentage.textContent = `${((overall.dropZoneGoals / overall.teamGoals) * 100).toFixed(1)}%`;
                        goalDropZoneCount.textContent = `(${overall.dropZoneGoals} of ${overall.teamGoals} goals)`;
                        goalReboundZonePercentage.textContent = `${(((overall.teamGoals - overall.dropZoneGoals) / overall.teamGoals) * 100).toFixed(1)}%`;
                        goalReboundZoneCount.textContent = `(${overall.teamGoals - overall.dropZoneGoals} of ${overall.teamGoals} goals)`;
                    } else { goalResultsSection.classList.add('hidden'); }
                    matchSummaryBody.innerHTML = '';
                    allMatchStats.forEach(match => {
                        const row = document.createElement('tr'); row.className = 'hover:bg-gray-800/50 transition-colors duration-200';
                        const scoreDropPct = match.teamScores > 0 ? ((match.dropZoneScores / match.teamScores) * 100).toFixed(1) : '0.0';
                        const goalDropPct = match.teamGoals > 0 ? ((match.dropZoneGoals / match.teamGoals) * 100).toFixed(1) : '0.0';
                        row.innerHTML = `<td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-300">${match.fileName}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.teamScores}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center font-semibold ${scoreDropPct >= 50 ? 'text-green-400' : 'text-blue-400'}">${scoreDropPct}%</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.teamGoals}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center font-semibold ${goalDropPct >= 50 ? 'text-green-400' : 'text-blue-400'}">${goalDropPct}%</td>`;
                        matchSummaryBody.appendChild(row);
                    });

                    // D50 to F50 Transitions
                    transitionPercentage.textContent = `${overall.transitionAttempts > 0 ? ((overall.successfulTransitions / overall.transitionAttempts) * 100).toFixed(1) : '0.0'}%`;
                    transitionCount.textContent = `(${overall.successfulTransitions} successful of ${overall.transitionAttempts} attempts)`;
                    transitionSummaryBody.innerHTML = '';
                    allMatchStats.forEach(match => {
                        const row = document.createElement('tr'); row.className = 'hover:bg-gray-800/50 transition-colors duration-200';
                        const successRate = match.transitionAttempts > 0 ? ((match.successfulTransitions / match.transitionAttempts) * 100).toFixed(1) : '0.0';
                        row.innerHTML = `<td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-300">${match.fileName}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.transitionAttempts}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.successfulTransitions}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center font-semibold text-teal-400">${successRate}%</td>`;
                        transitionSummaryBody.appendChild(row);
                    });

                    // Inside 45 Conversion
                    i45ConversionPercentage.textContent = `${overall.i45Kicks > 0 ? ((overall.successfulI45Conversions / overall.i45Kicks) * 100).toFixed(1) : '0.0'}%`;
                    i45ConversionCount.textContent = `(${overall.successfulI45Conversions} conversions from ${overall.i45Kicks} kicks)`;
                    i45SummaryBody.innerHTML = '';
                    allMatchStats.forEach(match => {
                        const row = document.createElement('tr'); row.className = 'hover:bg-gray-800/50 transition-colors duration-200';
                        const successRate = match.i45Kicks > 0 ? ((match.successfulI45Conversions / match.i45Kicks) * 100).toFixed(1) : '0.0';
                        row.innerHTML = `<td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-300">${match.fileName}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.i45Kicks}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.successfulI45Conversions}</td><td class="px-4 py-4 whitespace-nowrap text-sm text-center font-semibold text-orange-400">${successRate}%</td>`;
                        i45SummaryBody.appendChild(row);
                    });

                    // Scoring Efficiency
                    teamI50PerScore.textContent = overall.teamScores > 0 ? (overall.teamI50s / overall.teamScores).toFixed(1) : 'N/A';
                    teamI50PerGoal.textContent = overall.teamGoals > 0 ? (overall.teamI50s / overall.teamGoals).toFixed(1) : 'N/A';
                    oppoI50PerScore.textContent = overall.oppoScores > 0 ? (overall.oppoI50s / overall.oppoScores).toFixed(1) : 'N/A';
                    oppoI50PerGoal.textContent = overall.oppoGoals > 0 ? (overall.oppoI50s / overall.oppoGoals).toFixed(1) : 'N/A';
                    efficiencySummaryBody.innerHTML = '';
                    allMatchStats.forEach(match => {
                        const row = document.createElement('tr'); row.className = 'hover:bg-gray-800/50 transition-colors duration-200';
                        const teamPerScore = match.teamScores > 0 ? (match.teamI50s / match.teamScores).toFixed(1) : 'N/A';
                        const teamPerGoal = match.teamGoals > 0 ? (match.teamI50s / match.teamGoals).toFixed(1) : 'N/A';
                        const oppoPerScore = match.oppoScores > 0 ? (match.oppoI50s / match.oppoScores).toFixed(1) : 'N/A';
                        const oppoPerGoal = match.oppoGoals > 0 ? (match.oppoI50s / match.oppoGoals).toFixed(1) : 'N/A';
                        row.innerHTML = `<td class="px-2 py-4 whitespace-nowrap text-sm font-medium text-gray-300">${match.fileName}</td><td class="px-2 py-4 text-center text-sm text-indigo-400 font-semibold">${teamPerScore}</td><td class="px-2 py-4 text-center text-sm text-indigo-400 font-semibold">${teamPerGoal}</td><td class="px-2 py-4 text-center text-sm text-rose-400 font-semibold">${oppoPerScore}</td><td class="px-2 py-4 text-center text-sm text-rose-400 font-semibold">${oppoPerGoal}</td>`;
                        efficiencySummaryBody.appendChild(row);
                    });
                }

                // --- Update GPS Tab ---
                if (allGpsStats.length > 0) {
                    const winStats = allGpsStats.filter(s => s.gameResult.toUpperCase() === 'WIN');
                    const lossStats = allGpsStats.filter(s => s.gameResult.toUpperCase() === 'LOSS' || s.gameResult.toUpperCase() === 'LOSE');
                    
                    winCountSpan.textContent = winStats.length;
                    lossCountSpan.textContent = lossStats.length;

                    const calculateAverages = (statsArray) => {
                        if (statsArray.length === 0) return null;
                        const sums = statsArray.reduce((acc, match) => {
                            acc.avgTotalDistance += match.avgTotalDistance;
                            acc.avgSprintDistance += match.avgSprintDistance;
                            acc.avgSprintEfforts += match.avgSprintEfforts;
                            acc.avgHardRunning += match.avgHardRunning;
                            acc.avgHardRunningEfforts += match.avgHardRunningEfforts;
                            acc.avgWorkRate += match.avgWorkRate;
                            return acc;
                        }, { avgTotalDistance: 0, avgSprintDistance: 0, avgSprintEfforts: 0, avgHardRunning: 0, avgHardRunningEfforts: 0, avgWorkRate: 0 });
                        
                        return {
                            totalDistance: sums.avgTotalDistance / statsArray.length,
                            sprintDistance: sums.avgSprintDistance / statsArray.length,
                            sprintEfforts: sums.avgSprintEfforts / statsArray.length,
                            hardRunning: sums.avgHardRunning / statsArray.length,
                            hardRunningEfforts: sums.avgHardRunningEfforts / statsArray.length,
                            workRate: sums.avgWorkRate / statsArray.length,
                        };
                    };

                    const winAverages = calculateAverages(winStats);
                    const lossAverages = calculateAverages(lossStats);
                    
                    const createSummaryHTML = (averages) => {
                        if (!averages) return '<p class="text-gray-500">No data available.</p>';
                        return `
                            <div class="flex justify-between items-center text-sm"><span class="text-gray-400">Total Distance:</span><span class="font-semibold text-white">${averages.totalDistance.toFixed(0)} m</span></div>
                            <div class="flex justify-between items-center text-sm"><span class="text-gray-400">Sprint Distance:</span><span class="font-semibold text-white">${averages.sprintDistance.toFixed(1)} m</span></div>
                            <div class="flex justify-between items-center text-sm"><span class="text-gray-400">Sprint Efforts:</span><span class="font-semibold text-white">${averages.sprintEfforts.toFixed(1)}</span></div>
                            <div class="flex justify-between items-center text-sm"><span class="text-gray-400">Hard Running:</span><span class="font-semibold text-white">${averages.hardRunning.toFixed(1)} m</span></div>
                            <div class="flex justify-between items-center text-sm"><span class="text-gray-400">Hard Running Efforts:</span><span class="font-semibold text-white">${averages.hardRunningEfforts.toFixed(1)}</span></div>
                            <div class="flex justify-between items-center text-sm"><span class="text-gray-400">Work Rate:</span><span class="font-semibold text-white">${averages.workRate.toFixed(1)} m/min</span></div>
                        `;
                    };

                    gpsWinSummary.innerHTML = createSummaryHTML(winAverages);
                    gpsLossSummary.innerHTML = createSummaryHTML(lossAverages);

                    gpsSummaryBody.innerHTML = '';
                    allGpsStats.forEach(match => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-800/50 transition-colors duration-200';
                        const resultClass = match.gameResult.toUpperCase() === 'WIN' ? 'text-green-400' : 'text-red-400';
                        row.innerHTML = `
                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-300">${match.fileName}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center font-semibold ${resultClass}">${match.gameResult}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.avgTotalDistance.toFixed(0)}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.avgSprintDistance.toFixed(1)}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.avgSprintEfforts.toFixed(1)}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.avgHardRunning.toFixed(1)}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center text-gray-300">${match.avgHardRunningEfforts.toFixed(1)}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center font-semibold text-lime-400">${match.avgWorkRate.toFixed(1)}</td>
                        `;
                        gpsSummaryBody.appendChild(row);
                    });
                }


                // Show sections and set initial tab
                tabsContainer.classList.remove('hidden');
                resultsSection.classList.remove('hidden');
                noResultsMessage.classList.add('hidden');
                switchTab('scoring-zone');
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                tabsContainer.classList.add('hidden');
            }

            function hideError() {
                errorMessage.classList.add('hidden');
            }
            
            // --- Auto-run on page load ---
            fetchDataFromGitHub();
        });
    </script>
</body>
</html>
